---
/**
 * Error Boundary Component
 * Catches and displays errors gracefully
 */
export interface Props {
  fallback?: string;
  showDetails?: boolean;
}

const { fallback = 'Something went wrong', showDetails = import.meta.env.DEV } = Astro.props;
---

<div class="error-boundary">
  <slot />
</div>

<script define:vars={{ fallback, showDetails }}>
  // Error boundary logic runs client-side
  class ErrorBoundaryHandler {
    private container: HTMLElement | null = null;
    private originalContent: string = '';

    constructor() {
      this.init();
    }

    init() {
      this.container = document.querySelector('.error-boundary');
      if (!this.container) return;

      this.originalContent = this.container.innerHTML;

      // Catch global errors
      window.addEventListener('error', (event) => {
        this.handleError(event.error || new Error(event.message));
        event.preventDefault();
      });

      // Catch unhandled promise rejections
      window.addEventListener('unhandledrejection', (event) => {
        this.handleError(event.reason);
        event.preventDefault();
      });
    }

    handleError(error: Error) {
      if (!this.container) return;

      const errorMessage = error?.message || 'Unknown error';
      const errorStack = error?.stack || '';

      const errorHtml = `
        <div class="min-h-[200px] flex items-center justify-center p-6">
          <div class="cs-glass-lg rounded-2xl p-8 max-w-2xl w-full border border-red-500/20">
            <div class="flex items-start gap-4">
              <div class="flex-shrink-0">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <div class="flex-1">
                <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-2">
                  Error Occurred
                </h3>
                <p class="text-slate-700 dark:text-slate-300 mb-4">
                  ${fallback}
                </p>
                ${
                  showDetails
                    ? `
                  <details class="mt-4">
                    <summary class="cursor-pointer text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200">
                      Technical Details
                    </summary>
                    <div class="mt-2 p-4 bg-slate-100 dark:bg-slate-800 rounded-lg">
                      <p class="text-sm font-mono text-red-600 dark:text-red-400 mb-2">${this.escapeHtml(errorMessage)}</p>
                      ${errorStack ? `<pre class="text-xs text-slate-600 dark:text-slate-400 overflow-x-auto">${this.escapeHtml(errorStack)}</pre>` : ''}
                    </div>
                  </details>
                `
                    : ''
                }
                <button
                  onclick="location.reload()"
                  class="mt-4 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2"
                >
                  Reload Page
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      this.container.innerHTML = errorHtml;

      // Log error for debugging
      console.error('Error Boundary caught:', error);
    }

    escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // Initialize error boundary
  if (typeof window !== 'undefined') {
    new ErrorBoundaryHandler();
  }
</script>

<style>
  .error-boundary {
    min-height: inherit;
  }
</style>
